#! /usr/bin/env ruby

Thread.abort_on_exception = true

require 'curses'
require 'io/console'

YMAX, XMAX = STDIN.winsize
CLOCK   = 0.1
PADDING = 20

require 'curses_lib'
require 'launch'
require 'bang'
require 'launch_view'
require 'bang_view'

Curses::init_screen

# yes, I am bad, and I want to date your daughter.
class Range
  def any
    rand(self)
  end
end

Launch.fire

Thread.new do
  loop do
    Curses::refresh
    Curses::clear
    sleep CLOCK
  end
end

readLoop = lambda do |fire|
  lambda do
    loop do
      char = STDIN.getch
      Curses::clear if char == "c"
      Launch.fire if fire
      exit if char == "q"
    end
  end
end

readLoop[true].call if ARGV.none? { |arg| arg == "-r" }

Thread.new &readLoop[false]

loop do
  Launch.fire
  sleep Random.rand(0.5..2.0)
end

# http://www.petesqbsite.com/sections/tutorials/tuts/perspective.html
# ----------------------------------------
# Formula to solve Sx
# ----------------------------------------
# Ez = distance from eye to the center of the screen
# Ex = X coordinate of the eye
# Px = X coordinate of the 3D point
# Pz = Z coordinate of the 3D point
#              Ez*(Px-Ex)
# Sx  = -----------------------  + Ex
#                Ez+Pz
#
# ----------------------------------------
# Formula to solve Sy
# ----------------------------------------
# Ez = distance from eye to the center of the screen
# Ey = Y coordinate of the eye
# Py = Y coordinate of the 3D point
# Pz = Z coordinate of the 3D point
#            Ez*(Py-Ey)
# Sy  = -------------------  + Ey
#              Ez+Pz
